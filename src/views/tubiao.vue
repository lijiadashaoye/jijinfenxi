<template>
  <div>
    <input
      type="file"
      style="margin-bottom:10px;"
      @change="readExcel"
    />
    <!-- echarts 显示 -->
    <!-- <div style="width:100%;overflow:scroll" v-if="toShow">
      <div id="main" :style="{width:`${setWidth}px`,height:`${setHeight}px`}"></div>
    </div>-->
    <table
      border="1"
      collpase
      v-if="toShow&&kong.length"
    >
      <thead>
        <tr>
          <th colspan="2">没有持仓数据的，{{`${kong.length}个`}}</th>
        </tr>
      </thead>
      <tbody>
        <tr
          v-for="t in kong"
          :key="t.code"
        >
          <td>{{t.code}}</td>
          <td>{{t.name}}</td>
        </tr>
      </tbody>
    </table>
    <!-- 重合分析 -->
    <table
      border="1"
      collpase
      v-if="toShow"
    >
      <thead>
        <tr>
          <th colspan="3">重合分析</th>
        </tr>
      </thead>
      <tbody>
        <tr
          v-for="(t,ind) in chonghe"
          :key="ind"
        >
          <td>
            <p style="font-size:12px;margin:2px;color:rgb(216, 90, 201);">{{t.one.name}}</p>
            <p style="font-size:12px;margin:2px;">{{t.two.name}}</p>
          </td>
          <td style="font-size:12px;">{{t.num}}</td>
          <td style="font-size:12px;">{{(t.chong.map(d=>d.zcName)).sort().join('，')}}</td>
        </tr>
      </tbody>
    </table>
    <!-- 数据统计 -->
    <table
      border="1"
      collpase
      v-if="toShow"
    >
      <thead>
        <tr>
          <th colspan="4">数据统计</th>
        </tr>
        <tr>
          <th colspan="4">共{{allDatas.length}}个基金，
            {{kong.length}}个看不到持仓</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th>股票名称</th>
          <th
            class="sorrs"
            title="点击排序"
            @click="toSort(true)"
          >被持仓次数</th>
          <th
            class="sorrs"
            title="点击排序"
            @click="toSort(false)"
          >日涨幅 %</th>
          <th>
            持仓基金&nbsp;&nbsp;
            <span>{{jishu.length}}个股票，{{single}} 个股票被持有一次</span>&nbsp;&nbsp;
            <input
              type="text"
              placeholder="输入股票名称"
              v-model="jijins"
            />
            <button @click="search">搜索基金</button>
          </th>
        </tr>

        <tr
          v-for="(t,ind) in jishu"
          :key="ind"
          :ref="t.code"
        >
          <td
            :class="{'bk':t.num>=shaixuan}"
            style=" min-width: 125px;text-align: center;font-size: 16px;"
          >{{t.name}}
            <p style="margin:2px 0; min-width: 125px;text-align: center;font-size: 12px;">{{t.hangye}}</p>
          </td>
          <td style="text-align: center;">{{t.num}}</td>
          <td style="text-align: center;">{{t.zhangfu}}</td>
          <td style="font-size:12px;">{{t.jijin.join('，')}}</td>
        </tr>
      </tbody>
    </table>

  </div>
</template>

<script>
// import * as echarts from "echarts";
// https://www.jianshu.com/p/31534691ed53
import XLSX from "xlsx";

export default {
  data() {
    return {
      jijins: "", // 搜索基金用
      // 目前持有的基金
      allDatas: [],
      httpData: [], // 拉取得的服务器数据
      kong: [], // 保存为空的基金
      canSee: [], // 排除服务器数据中为空的基金
      jijinName: [], // 基金名称
      finallData: [],
      jishu: [], // 统计股票被持仓数量
      toShow: false,
      shaixuan: 5, // 用来筛选被持有量
      chonghe: [], // 用来求重合
      chongheNum: 4, // 用来定义重合数量

      setWidth: 0,
      setHeight: 0,
      single: 0, // 记录只被持有一次的个数
      range: "",

      allJiJin: [],
    };
  },
  created() {
    if (sessionStorage.getItem("datas")) {
      this.allJiJin = JSON.parse(sessionStorage.getItem("datas"));
    } else {
      this.allJiJin = require("./data.json").map((t) => ({
        code: t[0],
        name: t[2],
        type: t[3],
      }));
      sessionStorage.setItem("datas", JSON.stringify(this.allJiJin));
    }
    this.range = "A1:B200";
    // this.range = "C1:D200";
    // this.range = "E1:F200";
  },
  methods: {
    readExcel(ev) {
      var _this = this,
        files = ev.target.files[0],
        reader = new FileReader();
      reader.readAsArrayBuffer(files);

      reader.onload = function (e) {
        let fff = 0,
          workbook = XLSX.read(e.target.result, {
            type: "buffer",
          }),
          sheetNames = workbook.SheetNames; // 工作表名称集合
        let worksheet = workbook.Sheets[sheetNames[fff]], // 这里我们只读取第一张sheet1
          csv = XLSX.utils.sheet_to_json(worksheet, { range: _this.range });

        _this.allDatas = csv.map((t) => ({
          code: "" + t["代码"],
          name: "" + t["名字"],
        }));

        _this.getData();
      };
    },
    // 根据持有量或当日收益排序
    toSort(type) {
      if (type) {
        //  按被持仓次数排序
        this.jishu = this.jishu.sort((a, b) => {
          return b.num - a.num;
        });
      } else {
        //  按被日涨幅排序
        this.jishu = this.jishu.sort((a, b) => {
          // return a.zhangfu > b.zhangfu ? -1 : 1;
          return b.zhangfu - a.zhangfu;
        });
      }
    },
    // 获取所有基金的持股
    getData() {
      let proArr = [],
        jijin = this.allDatas.map((t) => t.code); // 提取基金号

      for (let i = 0; i < jijin.length; i++) {
        proArr.push(
          this.$axios({
            method: "get",
            url: `jijin/${jijin[i]}`,
          })
        );
      }
      Promise.all(proArr).then((res) => {
        this.httpData = res.map((t) => t.data.stock);
        this.laping(this.httpData);
        sessionStorage.setItem("httpData", JSON.stringify(this.httpData));
      });
    },
    // 将多维数组，拉成一维数组，并去除空数组
    laping(data) {
      // 选出空数组
      data.forEach((t, ind) => {
        if (t.length) {
          this.canSee.push(...t);
        } else {
          this.kong.push(this.allDatas[ind]);
        }
      });

      // 选出不为空的基金
      let kongArr = this.kong.map((t) => t.code);
      this.allDatas.forEach((t) => {
        if (!kongArr.includes(t.code)) {
          this.jijinName.push(t);
        }
      });
      let arr = [];
      // 统计数据
      this.canSee.forEach((t) => {
        let kk = arr.map((u) => u.code);
        if (!kk.includes(t.zcCode)) {
          arr.push({
            zhangfu: t.rate, // 涨幅
            code: t.zcCode, //  股票代码
            name: t.zcName,
            num: 0,
            jijin: [],
            jijinCode: [], // 基金的代码
          });
        }
      });

      this.canSee.forEach((t) => {
        let code = t.zcCode, //  股票代码
          inJishu = arr.filter((h) => h.code == code)[0], // 找出股票的数据
          jijin = this.allDatas.filter((h) => h.code == t.code)[0]; // 找出基金的名字
        inJishu.jijin.push(jijin.name);
        inJishu.jijinCode.push(jijin.code);
        inJishu.num++;
      });
      // 全部数据
      arr = arr.sort((a, b) => {
        return b.num - a.num;
      });

      // this.getCompany(arr);

      // 统计有几个股票被持有1次
      arr.forEach((t) => {
        if (t.num == 1) {
          this.single += +t.num;
        }
      });
      console.log(this.canSee);
      // 全部数据
      this.jishu = arr;
      // 持有量小于一定数目个的数据
      // this.jishu = arr.filter(t=>t.num<3);
      this.fenxi();
      // this.makeChart();
    },
    fenxi() {
      for (let j = this.httpData.length; j--; ) {
        let e = this.httpData[j];
        if (e.length) {
          let code = e[0].code,
            tar = this.allDatas.find((t) => t.code == code);
          tar.gupiao = e.map((t) => ({
            zcName: t.zcName,
            zcCode: t.zcCode,
          }));
        }
      }
      let arrs = [];
      this.allDatas.forEach((t) => {
        if (t.gupiao) {
          let gupiao = t.gupiao.map((k) => k.zcCode);

          for (let i = this.allDatas.length; i--; ) {
            if (this.allDatas[i].code != t.code && this.allDatas[i].gupiao) {
              let d = this.allDatas[i].gupiao.map((k) => k.zcCode),
                num = 0;
              gupiao.forEach((j) => {
                if (d.includes(j)) {
                  num++;
                }
              });
              if (num > this.chongheNum) {
                let a = new Set(t.gupiao.map((d) => d.zcCode));
                let b = new Set(this.allDatas[i].gupiao.map((d) => d.zcCode));
                let kk = [...new Set([...a].filter((x) => b.has(x)))];

                let obj = {
                  one: t,
                  two: this.allDatas[i],
                  num: num,
                  chong: t.gupiao.filter((t) => kk.includes(t.zcCode)),
                };
                arrs.push(obj);
              }
            }
          }
        }
      });

      setTimeout(() => {
        for (let j = arrs.length; j--; ) {
          let one = arrs[j].one.code,
            two = arrs[j].two.code,
            sortArr = [one, two].sort();
          if (!this.chonghe.length) {
            this.chonghe.push(arrs[j]);
          } else {
            let isIn = false;
            for (let i = this.chonghe.length; i--; ) {
              let one = this.chonghe[i].one.code,
                two = this.chonghe[i].two.code,
                sortArr1 = [one, two].sort();
              if (sortArr[0] == sortArr1[0] && sortArr[1] == sortArr1[1]) {
                isIn = true;
              }
            }
            if (!isIn) {
              this.chonghe.push(arrs[j]);
            }
          }
        }

        this.toShow = true;
      });
    },
    async getCompany(t) {
      for (let i = t.length; i--; ) {
        await this.$axios({
          method: "get",
          url: `gongsi/${t[i].code}`,
        }).then((res) => {
          if (res.resultCode == 0 && Object.keys(res.data).length) {
            t[i].hangye = `(${res.data.businessType.replace(" — ", "-")})`;
          }
        });
      }
      this.jishu = t;
      this.toShow = true;
    },

    // getCompany(t) {
    //   let num = 0;
    //   t.forEach((d) => {
    //     this.$axios({
    //       method: "get",
    //       url: `gongsi/${d.code}`,
    //     }).then((res) => {
    //       num++;
    //       if (res.resultCode == 0 && Object.keys(res.data).length) {
    //         d.hangye = `(${res.data["所属申万行业："].replace(" — ", "-")})`;
    //       }
    //     });
    //   });
    //   let time = setInterval(() => {
    //     if (num === t.length) {
    //       this.jishu = t;
    //       this.toShow = true;
    //       clearInterval(time);
    //     }
    //   }, 500);
    // },
    makeChart() {
      let forY = this.jishu.map((t) => t.name),
        forX = this.jijinName.map((t) => t.name);

      forX.forEach((t) => {
        if (t.length > this.setHeight) {
          this.setHeight = t.length * 20;
        }
      });
      forY.forEach((t) => {
        if (t.length > this.setWidth) {
          this.setWidth = t.length * 20;
        }
      });
      this.setWidth = this.setWidth + forX.length * 24;
      this.setHeight = this.setHeight + forY.length * 24;
      this.jishu.forEach((t, ind) => {
        t.jijinCode.forEach((d) => {
          let num = this.allDatas.findIndex((k) => k.code == d);
          // 点位数据，以索引标定位置 [x,y,tip]
          this.finallData.push([num, ind, t.zhangfu]);
        });
      });
      // let option = {
      //   title: {
      //     text: "股票投资公司分部",
      //   },
      //   tooltip: {
      //     position: "top",
      //     formatter: function (params) {
      //       return ` 日涨幅 ${params.value[2]}%`;
      //     },
      //   },
      //   grid: {
      //     left: 2,
      //     bottom: 5,
      //     right: 5,
      //     containLabel: true,
      //   },
      //   xAxis: {
      //     type: "category",
      //     data: forX,
      //     axisLabel: { rotate: 90 },
      //     splitLine: {
      //       show: true,
      //       lineStyle: {
      //         color: "#d3d0d0",
      //         type: "dashed",
      //       },
      //     },
      //     axisLine: {
      //       show: false,
      //     },
      //   },
      //   yAxis: {
      //     name: "股票",
      //     type: "category",
      //     data: forY,
      //     axisLine: {
      //       show: false,
      //     },
      //     splitLine: {
      //       show: true,
      //       lineStyle: {
      //         color: "#d3d0d0",
      //         type: "dashed",
      //       },
      //     },
      //   },
      //   series: [
      //     {
      //       type: "scatter",
      //       symbolSize: 10, //图元的大小
      //       data: this.finallData,
      //       color: "blue",
      //     },
      //   ],
      // };

      // this.toShow = true;

      // setTimeout(() => {
      //   var myChart = echarts.init(document.getElementById("main"));
      //   myChart.setOption(option);
      //   myChart.on("click", (params) => {
      //     let ind = params.value[0];
      //     window.open(`http://fund.10jqka.com.cn/${this.canSee[ind].code}/`);
      //   });
      // }, 100);
    },
    search() {
      if (this.jijins != "") {
        let code = this.jishu.filter((t) => t.name == this.jijins)[0].code;
        let tar = this.$refs[code][0];
        tar.setAttribute("style", "background:red;");
        setTimeout(() => {
          this.$refs[code][0].removeAttribute("style");
        }, 5000);
      }
    },
  },
};
</script>

<style>
table {
  border: 1px solid rgb(230, 123, 159);
  border-collapse: collapse; /*关键代码*/
}
th {
  min-width: 50px;
  text-align: center;
  padding: 0 5px;
}
td {
  padding: 2px 3px;
}
button {
  margin: 5px;
}
.sorrs {
  cursor: pointer;
}
.bk {
  background: palegoldenrod;
}
</style>